# CDK Simple API Gateway Cognito Authentication Stack

This AWS CDK stack sets up a simple REST API with Cognito authentication using Amazon API Gateway and AWS Lambda.

## Architecture Overview

```
  Client                  API Gateway               Cognito
    |                          |                        |
    | Request to /idToken      |                        |
    |------------------------->|                        |
    |                          |    Validate ID token   |
    |                          |    and authorize user  |
    |                          |<-----------------------|
    | Response with requested  |                        |
    | data                     |                        |
    |<-------------------------|------------------------|
    |                          |                        |
    | Request to /accessToken  |                        |
    | with access token        |                        |
    |------------------------->|                        |
    |                          |   Validate access     |
    |                          |   token and custom     |
    |                          |   scope                |
    |                          |<-----------------------|
    |                          |                        |
    | Response with requested  |                        |
    | data                     |                        |
    |<-------------------------|------------------------|
    |                          |                        |
    | Request to unsecure      |                        |
    | endpoint                 |                        |
    |------------------------->|                        |
    |                          |                        |
    | Response with requested  |                        |
    | data                     |                        |
    |<-------------------------|------------------------|

```

The stack provisions the following AWS resources:

- **Amazon Cognito User Pool**: Manages user authentication for the API.
- **Cognito User Pool Domain**: Customizes the domain for the Cognito User Pool.
- **Cognito User Pool Clients**: Provides various client configurations for different OAuth flows.
- **Cognito Resource Server**: Defines custom scopes for access control.
- **AWS Lambda Function**: Executes business logic for API endpoints.
- **Amazon API Gateway**: Exposes RESTful endpoints secured by Cognito authorizer.


The repository also contains

- [event](./event) folder : some sample API GW events (as seen by the lambdas)
- [tokens](./tokens) folder :  and some sample ID and Access tokens as generated by Cognito.

## Prerequisites

- AWS account with appropriate permissions to deploy CDK stacks.
- Node.js and npm installed.
- AWS CDK installed (`npm install -g aws-cdk`).

## Installation

1. Clone this repository.
2. Navigate to the project directory.
3. Install dependencies: `npm install`.
4. Deploy the stack to your AWS account: `cdk deploy`.

## Usage

Once deployed, the API endpoints will be available for usage. The endpoints are secured with Cognito authentication. You can access the endpoints using appropriate tokens provided by Cognito.

### Endpoints

- `GET /`: Root endpoint protected by Cognito authorizer.
- `GET /idToken`: Endpoint protected by Cognito authorizer, requiring ID token.
- `GET /accessToken`: Endpoint protected by Cognito authorizer, requiring access token with custom scope `test-resource-server1/user`.
- `GET /unsecure`: Unsecured endpoint without authentication.

## Configuration

Modify the code in `CdkSimpleApiGwCognitoAuthStack.ts` to customize the stack according to your requirements. You can adjust Cognito settings, Lambda function configurations, API Gateway endpoints, etc.

## Cleanup

To remove the stack and associated resources from your AWS account, use the following command:

```bash
cdk destroy
```
